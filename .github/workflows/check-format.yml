name: Code Format Check

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ '*' ]  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï –ø—É–ª—Ä–µ–∫–≤–µ—Å—Ç—ã –≤–æ –≤—Å–µ –≤–µ—Ç–∫–∏
  pull_request_target:
    branches: [ '*' ]  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Ñ–æ—Ä–∫–æ–≤

jobs:
  clang-format-check:
    name: Check Code Formatting
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # –î–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤ PR
      checks: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–≤–æ–π –≤–µ—Ç–∫–æ–π
        ref: ${{ github.event.pull_request.head.sha || github.sha }}
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v35
      with:
        files: |
          **/*.cpp
          **/*.h
          **/*.hpp
          **/*.c
          **/*.cc
          **/*.cxx
        separator: ","

    - name: Install clang-format
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "Installing clang-format..."
        sudo apt-get update
        sudo apt-get install -y clang-format
        echo "clang-format version: $(clang-format --version)"
        
    - name: Check formatting on changed files
      id: check_format
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        ERROR_COUNT=0
        UNFORMATTED_FILES=""
        ERROR_DETAILS=""
        PR_COMMENT=""
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ –º–∞—Å—Å–∏–≤
        IFS=',' read -ra CHANGED_FILES <<< "${{ steps.changed-files.outputs.all_changed_files }}"
        
        echo "Changed files to check:"
        for file in "${CHANGED_FILES[@]}"; do
          echo "  - $file"
        done
        echo ""
        
        for file in "${CHANGED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo ""
            echo "FILE: $file"
            echo "----------------------------------------"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -n (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞)
            if ! clang-format -n -Werror "$file" 2>clang_output.tmp; then
              ERROR_COUNT=$((ERROR_COUNT + 1))
              UNFORMATTED_FILES="$UNFORMATTED_FILES\n- $file"
              
              echo "ERROR_PATTERN: FORMATTING_VIOLATION"
              echo "FILE: $file"
              
              FILE_ERRORS=""
              
              # –ü–∞—Ä—Å–∏–º –≤—ã–≤–æ–¥ clang-format
              while IFS= read -r error_line; do
                if echo "$error_line" | grep -q "code should be clang-formatted"; then
                  # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏
                  LINE_NUM=$(echo "$error_line" | grep -o ":[0-9]*:" | head -1 | grep -o "[0-9]*")
                  
                  # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—É—é —Å—Ç—Ä–æ–∫—É
                  PROBLEM_LINE=$(sed -n "${LINE_NUM}p" "$file")
                  
                  # –ü–æ–ª—É—á–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
                  FIXED_LINE=$(clang-format "$file" | sed -n "${LINE_NUM}p")
                  
                  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ
                  if [ "$PROBLEM_LINE" = "$FIXED_LINE" ]; then
                    continue
                  fi
                  
                  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏ –¢–û–õ–¨–ö–û –ø–æ —Ä–µ–∞–ª—å–Ω—ã–º —Ä–∞–∑–ª–∏—á–∏—è–º
                  ERROR_TYPE="UNKNOWN"
                  ERROR_DESC="Code style violation"
                  FIX_DESC="Run clang-format -i $file"
                  
                  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É –∏—Å—Ö–æ–¥–Ω–æ–π –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
                  if echo "$PROBLEM_LINE" | grep -q "char \*\*[a-zA-Z]" && echo "$FIXED_LINE" | grep -q "char\*\*[a-zA-Z]"; then
                    ERROR_TYPE="POINTER_ALIGNMENT"
                    ERROR_DESC="'char **' should be 'char**'"
                    FIX_DESC="Remove space: 'char**'"
                  elif echo "$PROBLEM_LINE" | grep -q ")[:space:]*$" && echo "$FIXED_LINE" | grep -q ")[:space:]*{"; then
                    ERROR_TYPE="BRACE_PLACEMENT"
                    ERROR_DESC="Opening brace on new line"
                    FIX_DESC="Move '{' to same line: ) {"
                  elif echo "$PROBLEM_LINE" | grep -q "^[[:space:]]*if(" && echo "$FIXED_LINE" | grep -q "^[[:space:]]*if ("; then
                    ERROR_TYPE="SPACE_BEFORE_PAREN"
                    ERROR_DESC="Missing space between 'if' and '('"
                    FIX_DESC="Add space: 'if ('"
                  elif echo "$PROBLEM_LINE" | grep -q "^[[:space:]]*for(" && echo "$FIXED_LINE" | grep -q "^[[:space:]]*for ("; then
                    ERROR_TYPE="SPACE_BEFORE_PAREN"
                    ERROR_DESC="Missing space between 'for' and '('"
                    FIX_DESC="Add space: 'for ('"
                  elif echo "$PROBLEM_LINE" | grep -q "^[[:space:]]*while(" && echo "$FIXED_LINE" | grep -q "^[[:space:]]*while ("; then
                    ERROR_TYPE="SPACE_BEFORE_PAREN"
                    ERROR_DESC="Missing space between 'while' and '('"
                    FIX_DESC="Add space: 'while ('"
                  elif echo "$PROBLEM_LINE" | grep -q "\s\+$" && ! echo "$FIXED_LINE" | grep -q "\s\+$"; then
                    ERROR_TYPE="TRAILING_WHITESPACE"
                    ERROR_DESC="Trailing whitespace at end of line"
                    FIX_DESC="Remove spaces at end of line"
                  elif echo "$PROBLEM_LINE" | grep -q "^public:" && echo "$FIXED_LINE" | grep -q "^[[:space:]]\+public:"; then
                    ERROR_TYPE="ACCESS_SPECIFIER"
                    ERROR_DESC="'public:' should be indented"
                    FIX_DESC="Add 1-2 spaces before 'public:'"
                  elif echo "$PROBLEM_LINE" | grep -q "^private:" && echo "$FIXED_LINE" | grep -q "^[[:space:]]\+private:"; then
                    ERROR_TYPE="ACCESS_SPECIFIER"
                    ERROR_DESC="'private:' should be indented"
                    FIX_DESC="Add 1-2 spaces before 'private:'"
                  elif echo "$PROBLEM_LINE" | grep -q "\t" && ! echo "$FIXED_LINE" | grep -q "\t"; then
                    ERROR_TYPE="TAB_CHARACTER"
                    ERROR_DESC="Tab character detected. Use spaces for indentation"
                    FIX_DESC="Replace tabs with spaces (2 spaces per tab)"
                  elif echo "$PROBLEM_LINE" | grep -q "^\s*}[^,}]?else" && echo "$FIXED_LINE" | grep -q "^\s*} else"; then
                    ERROR_TYPE="ELSE_NEWLINE"
                    ERROR_DESC="'else' should be on same line as closing brace"
                    FIX_DESC="Format as: '} else {'"
                  elif echo "$PROBLEM_LINE" | grep -q "^\s*//[^[:space:]]" && echo "$FIXED_LINE" | grep -q "^\s*// "; then
                    ERROR_TYPE="COMMENT_SPACING"
                    ERROR_DESC="Missing space after //"
                    FIX_DESC="Add space: '// comment'"
                  fi
                  
                  # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
                  ERROR_ENTRY="  ERROR_PATTERN: $ERROR_TYPE\n  ERROR_FILE: $file\n  ERROR_LINE: $LINE_NUM\n  ERROR_DESC: $ERROR_DESC\n  ERROR_CODE: \"$PROBLEM_LINE\"\n  FIXED_CODE: \"$FIXED_LINE\"\n  HOW_TO_FIX: $FIX_DESC\n  FIX_COMMAND: clang-format -i $file\n---"
                  
                  echo "$ERROR_ENTRY"
                  
                  FILE_ERRORS="$FILE_ERRORS\n$ERROR_ENTRY"
                  ERROR_DETAILS="$ERROR_DETAILS\n$ERROR_ENTRY"
                  
                  # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è PR
                  PR_COMMENT="$PR_COMMENT\n- **$file:$LINE_NUM** - $ERROR_DESC\n  \`\`\`diff\n- $PROBLEM_LINE\n+ $FIXED_LINE\n  \`\`\`\n"
                fi
              done < clang_output.tmp
              
              if [ -n "$FILE_ERRORS" ]; then
                echo ""
                echo "SUMMARY for $file:"
                echo "  This file contains formatting violations"
                echo "  Run: clang-format -i $file"
              fi
            else
              echo "  PASS: $file is properly formatted"
            fi
          fi
        done
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
        echo "ERROR_COUNT=$ERROR_COUNT" >> $GITHUB_OUTPUT
        echo "UNFORMATTED_FILES<<EOF" >> $GITHUB_OUTPUT
        printf "%b\n" "$UNFORMATTED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "PR_COMMENT<<EOF" >> $GITHUB_OUTPUT
        printf "%b\n" "$PR_COMMENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        if [ $ERROR_COUNT -gt 0 ]; then
          echo ""
          echo "========================================="
          echo "ERROR_PATTERN: FORMATTING_FAILURE"
          echo "ERROR_SUMMARY: $ERROR_COUNT files need formatting"
          echo "ERROR_FILES:"
          printf "%b\n" "$UNFORMATTED_FILES"
          echo "========================================="
          exit 1
        else
          echo ""
          echo "========================================="
          echo "FORMATTING_CHECK: SUCCESS"
          echo "All changed files are properly formatted"
          echo "========================================="
        fi
        
    - name: Comment PR with formatting errors
      if: github.event_name == 'pull_request' && failure() && steps.check_format.outputs.PR_COMMENT != ''
      uses: actions/github-script@v6
      with:
        script: |
          const comment = `##Code Formatting Issues Found
          
          The following files have formatting violations that need to be fixed:
          
          ${{ steps.check_format.outputs.PR_COMMENT }}
          
          ### üîß Quick Fix
          
          Run these commands locally:
          \`\`\`bash
          # Fix all changed files
          ${{ steps.check_format.outputs.UNFORMATTED_FILES }} | xargs clang-format -i
          
          # Or fix specific file
          clang-format -i <filename>
          \`\`\`
          
          ###Common Issues
          
          | Error Pattern | Description | Fix |
          |--------------|-------------|-----|
          | POINTER_ALIGNMENT | 'char **' should be 'char**' | Remove space |
          | BRACE_PLACEMENT | Opening brace on new line | Move to same line |
          | SPACE_BEFORE_PAREN | Missing space before '(' | Add space |
          | TRAILING_WHITESPACE | Spaces at end of line | Remove them |
          | ACCESS_SPECIFIER | 'public:' not indented | Add 2 spaces |
          | TAB_CHARACTER | Tab character used | Use spaces |
          
          Please fix these issues and push the changes.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: Success comment on PR
      if: github.event_name == 'pull_request' && success() && steps.changed-files.outputs.any_changed == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '**Code formatting check passed!** All changed files are properly formatted.'
          });
          
    - name: Skip message (no C++ files changed)
      if: steps.changed-files.outputs.any_changed == 'false'
      run: |
        echo "========================================="
        echo "No C++ files were changed in this PR"
        echo "Skipping formatting check"
        echo "========================================="