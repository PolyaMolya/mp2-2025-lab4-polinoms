name: Code Format Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  clang-format-check:
    name: Check Code Formatting
    runs-on: ubuntu-latest  # –ò—Å–ø–æ–ª—å–∑—É–µ–º Linux –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    
    steps:
    # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout code
      uses: actions/checkout@v3
      
    # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º clang-format
    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format
        
    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    - name: Check formatting
      run: |
        echo "Checking C++ files formatting..."
        
        # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ C++ —Ñ–∞–π–ª—ã –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        # -n: —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∏–∑–º–µ–Ω—è—Ç—å —Ñ–∞–π–ª—ã
        # -Werror: —Ç—Ä–∞–∫—Ç–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∫–∞–∫ –æ—à–∏–±–∫–∏
        find . -name "*.cpp" -o -name "*.h" -o -name "*.hpp" -o -name "*.c" | \
          xargs clang-format -n -Werror --verbose
        
        echo "‚úÖ All files are properly formatted!"
        
      # –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö:
    - name: Check formatting (with diff)
      run: |
        echo "üîç Checking code formatting..."
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–ø–∏—é —Ñ–∞–π–ª–æ–≤
        mkdir -p /tmp/formatted
        find . -name "*.cpp" -o -name "*.h" -o -name "*.hpp" -o -name "*.c" > /tmp/files.txt
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            clang-format "$file" > "/tmp/formatted/$(echo "$file" | tr '/' '_')"
          fi
        done < /tmp/files.txt
        
        # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—ã —Å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏
        errors=0
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            temp_name="/tmp/formatted/$(echo "$file" | tr '/' '_')"
            if ! diff -u "$file" "$temp_name" > /dev/null; then
              echo "‚ùå File needs formatting: $file"
              echo "Diff:"
              diff -u "$file" "$temp_name" || true
              errors=$((errors + 1))
            fi
          fi
        done < /tmp/files.txt
        
        if [ $errors -gt 0 ]; then
          echo ""
          echo "‚ö†Ô∏è  Found $errors file(s) with formatting issues!"
          echo "üí° Run locally: find . -name '*.cpp' -o -name '*.h' -o -name '*.hpp' | xargs clang-format -i"
          exit 1
        else
          echo "‚úÖ All files are properly formatted!"
        fi